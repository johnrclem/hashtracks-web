// HashTracks — Full data model from PRD Section 4
// Source of truth for all application types

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ── USERS ──

model User {
  id          String       @id @default(cuid())
  clerkId     String       @unique
  hashName    String?      // Public display name (primary identity)
  nerdName    String?      // Real name (private by default)
  email       String       @unique
  bio         String?
  homeKennels UserKennel[]
  attendances Attendance[]
  hareCredits EventHare[]
  // Misman relations
  kennelHasherLinks   KennelHasherLink[]
  mismanRequests      MismanRequest[]
  recordedAttendances KennelAttendance[] @relation("RecordedAttendances")
  sentInvites           MismanInvite[]     @relation("SentInvites")
  acceptedInvites       MismanInvite[]     @relation("AcceptedInvites")
  rosterGroupRequests   RosterGroupRequest[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model UserKennel {
  id        String         @id @default(cuid())
  userId    String
  kennelId  String
  role      UserKennelRole @default(MEMBER)
  user      User           @relation(fields: [userId], references: [id])
  kennel    Kennel         @relation(fields: [kennelId], references: [id])
  createdAt DateTime       @default(now())

  @@unique([userId, kennelId])
}

enum UserKennelRole {
  MEMBER // Subscribed hasher
  ADMIN  // Can edit kennel details + all MISMAN permissions
  MISMAN // Can manage roster + attendance for this kennel
}

// ── KENNELS ──

model Kennel {
  id          String         @id @default(cuid())
  kennelCode  String         @unique // Permanent identity — set once, never changes
  shortName   String         // Display name (unique within region, not globally)
  slug        String         @unique // URL-safe: "nych3", "bos-moon"
  fullName    String         // "New York City Hash House Harriers"
  region      String         // "New York City, NY"
  country     String         @default("USA")
  description String?
  website     String?

  // ── SCHEDULE ──
  scheduleDayOfWeek  String?   // "Monday", "Saturday" (display string)
  scheduleTime       String?   // "7:00 PM", "12:00 Noon" (display string)
  scheduleFrequency  String?   // "Weekly", "Biweekly", "Monthly", "Full Moon"
  scheduleNotes      String?   // Seasonal or special notes

  // ── SOCIAL & CONTACT ──
  facebookUrl        String?
  instagramHandle    String?   // Handle only: "@londonhash"
  twitterHandle      String?   // Handle only: "@sfh3"
  discordUrl         String?
  mailingListUrl     String?
  contactEmail       String?
  contactName        String?   // "Grand Master: Mudflap"

  // ── DETAILS ──
  hashCash           String?   // "$5", "Free", "$7/$10 visitor"
  paymentLink        String?   // Venmo/PayPal/CashApp URL
  foundedYear        Int?
  logoUrl            String?

  // ── FLAGS ──
  dogFriendly        Boolean?  // null = unknown
  walkersWelcome     Boolean?  // null = unknown

  aliases     KennelAlias[]
  sources     SourceKennel[]
  events      Event[]
  members     UserKennel[]
  // Misman relations
  kennelHashers  KennelHasher[]
  mismanRequests MismanRequest[]
  mismanInvites  MismanInvite[]
  rosterGroups   RosterGroupKennel[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([shortName, region])
}

model KennelAlias {
  id       String @id @default(cuid())
  kennelId String
  alias    String // "NYC Hash", "HashNYC", "NYC", etc.
  kennel   Kennel @relation(fields: [kennelId], references: [id])

  @@unique([kennelId, alias])
  @@index([alias])
}

// ── SOURCES ──

model Source {
  id            String       @id @default(cuid())
  name          String       // "HashNYC Website"
  url           String       // "https://hashnyc.com"
  type          SourceType
  config        Json?        // Adapter-specific config (CSS selectors, calendar ID, etc.)
  trustLevel    Int          @default(5) // 1-10 scale
  scrapeFreq    String       @default("daily") // "hourly", "daily", "weekly"
  lastScrapeAt  DateTime?
  lastSuccessAt DateTime?
  healthStatus  SourceHealth @default(UNKNOWN)
  scrapeDays    Int          @default(90) // Lookback window in days for cron
  kennels       SourceKennel[]
  rawEvents     RawEvent[]
  scrapeLogs    ScrapeLog[]
  alerts        Alert[]
  eventLinks    EventLink[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

enum SourceType {
  HTML_SCRAPER    // hashnyc.com, hashnj.com
  GOOGLE_CALENDAR // bostonhash@gmail.com
  GOOGLE_SHEETS   // Summit H3 spreadsheet
  ICAL_FEED       // .ics URL
  RSS_FEED        // RSS/Atom feed
  JSON_API        // Generic JSON API
  HASHREGO        // hashrego.com event pages
  MANUAL          // User-submitted events
}

model ScrapeLog {
  id            String       @id @default(cuid())
  sourceId      String
  status        ScrapeStatus @default(RUNNING)
  startedAt     DateTime     @default(now())
  completedAt   DateTime?
  durationMs    Int?
  eventsFound   Int          @default(0)
  eventsCreated Int          @default(0)
  eventsUpdated Int          @default(0)
  eventsSkipped Int          @default(0)
  unmatchedTags String[]
  errors        String[]
  forced        Boolean      @default(false)
  // Quality metrics
  fillRateTitle     Int?     // % of events with non-empty title (0-100)
  fillRateLocation  Int?     // % of events with non-empty location
  fillRateHares     Int?     // % of events with non-empty hares
  fillRateStartTime Int?     // % of events with non-empty startTime
  fillRateRunNumber Int?     // % of events with non-empty runNumber
  structureHash     String?  // HTML structural fingerprint (HTML sources only)
  // Enhanced logging (Phase 2 + Phase 3)
  errorDetails      Json?    // Structured error breakdown: {fetch: [], parse: [], merge: []}
  sampleBlocked     Json?    // 3-5 example blocked events with reason + suggested action
  sampleSkipped     Json?    // 3-5 example skipped events with reason + suggested action
  fetchDurationMs   Int?     // Time for adapter.fetch() (HTTP + parsing)
  mergeDurationMs   Int?     // Time for processRawEvents()
  diagnosticContext Json?    // Per-adapter metadata (row counts, tabs, calendar IDs)
  source        Source       @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  alerts        Alert[]

  @@index([sourceId, startedAt])
}

enum ScrapeStatus {
  RUNNING
  SUCCESS
  FAILED
}

enum SourceHealth {
  HEALTHY  // Last scrape succeeded
  DEGRADED // Fewer events than expected
  FAILING  // Last N scrapes failed
  STALE    // No scrape attempted in >7 days
  UNKNOWN  // Never scraped
}

model SourceKennel {
  id       String @id @default(cuid())
  sourceId String
  kennelId String
  source   Source @relation(fields: [sourceId], references: [id])
  kennel   Kennel @relation(fields: [kennelId], references: [id])

  @@unique([sourceId, kennelId])
}

// ── EVENTS ──

model RawEvent {
  id          String   @id @default(cuid())
  sourceId    String
  rawData     Json     // Exact data as scraped — immutable
  fingerprint String   // Hash of key fields for change detection
  scrapedAt   DateTime @default(now())
  processed   Boolean  @default(false)
  eventId     String?  // Link to canonical Event after processing
  source      Source   @relation(fields: [sourceId], references: [id])
  event       Event?   @relation(fields: [eventId], references: [id])

  @@index([sourceId, scrapedAt])
  @@index([fingerprint])
}

model Event {
  id              String      @id @default(cuid())
  kennelId        String
  date            DateTime    // Event date (UTC noon to avoid DST issues)
  dateUtc         DateTime?   // Same moment in UTC (for cross-timezone queries)
  timezone        String?     // IANA timezone (e.g., "America/New_York")
  runNumber       Int?        // Kennel-specific sequential number
  title           String?     // Trail/event name
  description     String?
  haresText       String?     // Display text: "Mudflap, Just Simon"
  locationName    String?     // Start location name
  locationAddress String?
  latitude        Float?
  longitude       Float?
  startTime       String?     // Local time string "HH:MM" — NOT a timestamp
  sourceUrl       String?     // Link to original event page
  trustLevel      Int         @default(5)
  isSeriesParent  Boolean     @default(false)
  parentEventId   String?
  status          EventStatus @default(CONFIRMED)

  kennel      Kennel      @relation(fields: [kennelId], references: [id])
  parentEvent Event?      @relation("EventSeries", fields: [parentEventId], references: [id])
  childEvents Event[]     @relation("EventSeries")
  rawEvents   RawEvent[]
  hares       EventHare[]
  attendances Attendance[]
  eventLinks  EventLink[]
  // Misman relations
  kennelAttendances KennelAttendance[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([kennelId, date]) // De-duplication key
  @@index([date])
  @@index([kennelId, date])
}

model EventLink {
  id        String   @id @default(cuid())
  eventId   String
  url       String
  label     String   // e.g., "Hash Rego", "Meetup", "Kennel Website"
  sourceId  String?  // Which source created this link (nullable for manual)
  createdAt DateTime @default(now())

  event  Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  source Source? @relation(fields: [sourceId], references: [id], onDelete: SetNull)

  @@unique([eventId, url]) // Prevent duplicate links
  @@index([eventId])
}

enum EventStatus {
  CONFIRMED
  TENTATIVE
  CANCELLED
}

model EventHare {
  id         String         @id @default(cuid())
  eventId    String
  hareName   String         // Display name (always populated)
  userId     String?        // Optional link to User record
  role       HareRole       @default(HARE)
  sourceType HareSourceType @default(SCRAPED)
  event      Event          @relation(fields: [eventId], references: [id])
  user       User?          @relation(fields: [userId], references: [id])

  @@unique([eventId, hareName]) // Prevent duplicate hare entries
  @@index([eventId])
}

enum HareRole {
  HARE
  CO_HARE
  LIVE_HARE
}

enum HareSourceType {
  SCRAPED      // From scraper pipeline (haresText parsing)
  MISMAN_SYNC  // From misman attendance hare flag
}

// ── ATTENDANCE ──

model Attendance {
  id                 String             @id @default(cuid())
  userId             String
  eventId            String
  status             AttendanceStatus   @default(CONFIRMED)
  participationLevel ParticipationLevel @default(RUN)
  stravaUrl          String?
  beezThere          Boolean            @default(false)
  notes              String?            // User's personal notes
  isVerified         Boolean            @default(false) // Verified by misman (v2)
  verifiedBy         String?            // Misman user ID (v2)

  user    User    @relation(fields: [userId], references: [id])
  event   Event   @relation(fields: [eventId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventId])
}

enum AttendanceStatus {
  INTENDING // "I'm going" — pre-event RSVP
  CONFIRMED // "I was there" — post-event check-in
}

enum ParticipationLevel {
  RUN         // R - Standard trail participation
  HARE        // H - Set the trail
  BAG_HERO    // BH - Carried the beer
  DRINK_CHECK // DC - Manned a beer stop
  BEER_MILE   // BM - Beer mile event
  WALK        // W - Walk/Crawl
  CIRCLE_ONLY // C - Circle only (no trail)
}

// ── ALERTS ──

model Alert {
  id           String        @id @default(cuid())
  sourceId     String
  scrapeLogId  String?
  type         AlertType
  severity     AlertSeverity @default(WARNING)
  title        String        // Short summary: "Event count dropped 65%"
  details      String?       // Longer explanation with data
  context      Json?         // Structured data that triggered this alert (type-specific shape)
  repairLog    Json?         // Array of repair actions taken: [{action, timestamp, adminId, details, result}]
  status       AlertStatus   @default(OPEN)
  snoozedUntil DateTime?
  resolvedAt   DateTime?
  resolvedBy   String?       // User ID who resolved
  source       Source        @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  scrapeLog    ScrapeLog?    @relation(fields: [scrapeLogId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([sourceId, status])
  @@index([status, createdAt])
}

enum AlertType {
  EVENT_COUNT_ANOMALY   // Event count dropped >50% vs rolling avg
  FIELD_FILL_DROP       // Field fill rate dropped significantly
  STRUCTURE_CHANGE      // HTML structure fingerprint changed
  SCRAPE_FAILURE        // Scrape failed entirely
  CONSECUTIVE_FAILURES  // Multiple consecutive failures
  UNMATCHED_TAGS        // New unmatched kennel tags appeared
  SOURCE_KENNEL_MISMATCH // Resolved kennel not linked to source
}

enum AlertSeverity {
  INFO     // Noteworthy but not actionable
  WARNING  // Needs review soon
  CRITICAL // Needs immediate attention
}

enum AlertStatus {
  OPEN         // Needs attention
  ACKNOWLEDGED // Admin has seen it but not resolved
  SNOOZED      // Temporarily silenced
  RESOLVED     // Addressed
}

// ── KENNEL REQUESTS ──

model KennelRequest {
  id         String        @id @default(cuid())
  userId     String
  kennelName String
  region     String?
  country    String?
  sourceUrl  String?       // Website, Facebook page, etc.
  notes      String?
  status     RequestStatus @default(PENDING)
  resolvedAt DateTime?
  createdAt  DateTime      @default(now())
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ── MISMAN ENUMS ──

enum HasherLinkStatus {
  SUGGESTED  // System or misman suggested link; awaiting user confirmation
  CONFIRMED  // User accepted the link
  DISMISSED  // User dismissed the suggestion
}

enum ReferralSource {
  WORD_OF_MOUTH
  SOCIAL_MEDIA
  REDDIT
  MEETUP
  GOOGLE_SEARCH
  OTHER
}

// ── KENNEL ROSTER ──

model KennelHasher {
  id             String   @id @default(cuid())
  rosterGroupId  String   // Primary scope — every hasher belongs to a RosterGroup
  kennelId       String?  // "Created via" metadata — which kennel's misman added this entry
  hashName       String?  // Public display name (primary identifier)
  nerdName       String?  // Real name (private, visible to misman only)
  email          String?  // Contact email (private, visible to misman only)
  phone          String?  // Mobile phone (private, visible to misman only)
  notes          String?  // Internal misman notes
  mergeLog       Json?    // Audit trail for merge operations

  rosterGroup RosterGroup         @relation(fields: [rosterGroupId], references: [id])
  kennel      Kennel?             @relation(fields: [kennelId], references: [id])
  attendances KennelAttendance[]
  userLink    KennelHasherLink?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // At least one of hashName or nerdName must be provided (enforced in app logic)
  @@index([rosterGroupId])
  @@index([rosterGroupId, hashName])
  @@index([rosterGroupId, nerdName])
  @@index([kennelId])
}

// ── USER ↔ KENNEL HASHER LINKING ──

model KennelHasherLink {
  id             String           @id @default(cuid())
  kennelHasherId String           @unique // One link per KennelHasher
  userId         String
  status         HasherLinkStatus @default(SUGGESTED)
  suggestedBy    String?          // "system" or misman user ID who suggested
  confirmedBy    String?          // User ID who confirmed (always the linked user)
  dismissedBy    String?          // User ID or misman ID who dismissed

  kennelHasher KennelHasher @relation(fields: [kennelHasherId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([userId, status])
}

// ── MISMAN-RECORDED ATTENDANCE ──

model KennelAttendance {
  id              String          @id @default(cuid())
  kennelHasherId  String
  eventId         String
  paid            Boolean         @default(false)
  haredThisTrail  Boolean         @default(false)
  isVirgin        Boolean         @default(false)
  isVisitor       Boolean         @default(false)
  visitorLocation String?         // Where they're visiting from
  referralSource  ReferralSource? // How they found the hash
  referralOther   String?         // Freetext when referralSource is OTHER
  recordedBy      String          // Misman user ID who created this record
  editLog         Json?           // Array of AuditLogEntry objects (edit history)

  kennelHasher   KennelHasher @relation(fields: [kennelHasherId], references: [id])
  event          Event        @relation(fields: [eventId], references: [id])
  recordedByUser User         @relation("RecordedAttendances", fields: [recordedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([kennelHasherId, eventId]) // One attendance per hasher per event
  @@index([eventId])
  @@index([kennelHasherId])
}

// ── MISMAN ACCESS REQUESTS ──

model MismanRequest {
  id         String        @id @default(cuid())
  userId     String
  kennelId   String
  message    String?       // "I'm the misman for GGFM, please grant access"
  status     RequestStatus @default(PENDING) // Reuses existing enum
  resolvedBy String?       // User ID of admin or misman who approved/rejected
  resolvedAt DateTime?

  user    User    @relation(fields: [userId], references: [id])
  kennel  Kennel  @relation(fields: [kennelId], references: [id])
  createdAt DateTime @default(now())

  // No unique constraint — allows re-requests after rejection.
  // App logic prevents duplicate PENDING requests for the same user+kennel.
  @@index([userId, kennelId, status])
}

// ── ROSTER GROUPS (Cross-Kennel Roster Sharing) ──

model RosterGroup {
  id             String              @id @default(cuid())
  name           String              // "NYC Metro", "Philly Area"
  kennels        RosterGroupKennel[]
  kennelHashers  KennelHasher[]
  createdAt      DateTime            @default(now())
}

model RosterGroupKennel {
  id       String      @id @default(cuid())
  groupId  String
  kennelId String
  group    RosterGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  kennel   Kennel      @relation(fields: [kennelId], references: [id])

  @@unique([groupId, kennelId])
  @@unique([kennelId]) // A kennel can only be in one Roster Group
}

// ── MISMAN INVITES ──

model MismanInvite {
  id           String             @id @default(cuid())
  kennelId     String
  inviterId    String             // Misman user ID who created the invite
  inviteeEmail String?            // Optional: email of intended recipient (for future email integration)
  token        String             @unique // crypto.randomBytes(32), base64url-encoded
  status       MismanInviteStatus @default(PENDING)
  expiresAt    DateTime           // Computed at creation: now() + configured duration
  acceptedBy   String?            // User ID who redeemed the invite
  acceptedAt   DateTime?
  revokedAt    DateTime?

  kennel   Kennel @relation(fields: [kennelId], references: [id])
  inviter  User   @relation("SentInvites", fields: [inviterId], references: [id])
  acceptor User?  @relation("AcceptedInvites", fields: [acceptedBy], references: [id])

  createdAt DateTime @default(now())

  @@index([kennelId, status])
  @@index([token])
}

enum MismanInviteStatus {
  PENDING   // Link generated, not yet used
  ACCEPTED  // Invitee redeemed it
  EXPIRED   // Display-only — checked at read time, not actively written
  REVOKED   // Inviter cancelled before use
}

// ── ROSTER GROUP REQUESTS ──

model RosterGroupRequest {
  id            String        @id @default(cuid())
  userId        String
  proposedName  String        // e.g., "NYC Metro"
  kennelIds     Json          // Array of kennel IDs they want grouped
  message       String?       // Optional explanation
  status        RequestStatus @default(PENDING)
  resolvedBy    String?
  resolvedAt    DateTime?
  user          User          @relation(fields: [userId], references: [id])
  createdAt     DateTime      @default(now())

  @@index([status])
}
